<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bard Chatbot</title>
    <style>
      body {
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        margin: 0;
        background-color: #f5f5f5;
      }

      .chat-container {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        margin: 70px;
      }

      .message-box {
        flex-grow: 1;
        overflow-y: scroll;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .message {
        margin-bottom: 10px;
      }

      .bard-message {
        text-align: right;
        background-color: #e0e0e0;
        border-radius: 5px 0 0 5px;
        padding: 5px 10px;
      }

      .user-message {
        background-color: #fff;
        border-radius: 0 5px 5px 0;
        padding: 5px 10px;
      }

      .input-container {
        display: flex;
        margin-top: 10px;
      }

      .input-field {
        flex-grow: 1;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .send-button {
        padding: 5px 10px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .api-key-input {
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div class="api-key-container">
      <input
        type="text"
        class="api-key-input"
        id="apiKeyInput"
        placeholder="Enter your API key"
      />
      <button class="submit-api-key-button" onclick="submitApiKey()">
        Submit
      </button>
    </div>
    <div class="chat-container">
      <div class="message-box"></div>
      <div class="input-container">
        <input
          type="text"
          class="input-field"
          id="userInput"
          placeholder="Ask me anything"
          onkeydown="if(event.keyCode===13) sendMessage()"
        />
        <button class="send-button" onclick="sendMessage()">Send</button>
        <button class="voice-button" onclick="startVoiceRecognition()">
          Speak
        </button>
      </div>
    </div>
    <script>
      let apiKey = ""; // Global variable to store API key
      let conversationHistory = [
        // Include the provided prompt in the conversation history
        {
          role: "system",
          content: "Act like you are human and my friend",
        },
      ];

      // Initialize Web Speech API objects
      const recognition = new (window.SpeechRecognition ||
        window.webkitSpeechRecognition ||
        window.mozSpeechRecognition ||
        window.msSpeechRecognition)();
      const synthesis = window.speechSynthesis;

      function submitApiKey() {
        apiKey = document.getElementById("apiKeyInput").value.trim();
        if (!apiKey) {
          alert("Please enter your API key!");
          return;
        }

        alert("API Key Submitted Successfully!");
      }

      function sendMessage() {
        var userInput = document.getElementById("userInput").value;
        if (!userInput.trim()) {
          alert("Please enter a message!");
          return;
        }
        displayUserMessage(userInput);
        document.getElementById("userInput").value = ""; // Clear the message input box
        getOpenAIResponse(userInput);
      }

      function displayUserMessage(message) {
        var messageBox = document.querySelector(".message-box");
        var userMessageElement = document.createElement("div");
        userMessageElement.className = "message user-message";
        userMessageElement.innerText = message;
        messageBox.appendChild(userMessageElement);
        messageBox.scrollTop = messageBox.scrollHeight;
      }

      function displayOpenAIMessage(message) {
        var messageBox = document.querySelector(".message-box");
        var openAIMessageElement = document.createElement("div");
        openAIMessageElement.className = "message openai-message";
        openAIMessageElement.innerText = message;
        messageBox.appendChild(openAIMessageElement);
        messageBox.scrollTop = messageBox.scrollHeight;

        // Speak the bot's response
        speak(message);
      }

      function speak(text) {
        const utterance = new SpeechSynthesisUtterance(text);

        // Explicitly set a voice with a more feminine quality if available
        const voices = synthesis.getVoices();
        const feminineVoice = voices.find(
          (voice) =>
            voice.name.includes("Female") || voice.name.includes("Girl")
        );
        if (feminineVoice) {
          utterance.voice = feminineVoice;
        }

        synthesis.speak(utterance);
      }

      function getOpenAIResponse(userInput) {
        var endpoint = "https://api.openai.com/v1/chat/completions";

        // Construct request body with conversation history
        var requestBody = {
          model: "gpt-3.5-turbo",
          messages: conversationHistory.concat([
            {
              role: "user",
              content: userInput,
            },
          ]),
          temperature: 1,
          max_tokens: 256,
          top_p: 1,
          frequency_penalty: 0,
          presence_penalty: 0,
        };

        fetch(endpoint, {
          method: "POST",
          body: JSON.stringify(requestBody),
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + apiKey,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            var openAIResponse = data.choices[0].message.content.trim(); // Extracting response from the JSON
            displayOpenAIMessage(openAIResponse);
            // Update conversation history with current user message and bot response
            conversationHistory = requestBody.messages.concat([
              { role: "assistant", content: openAIResponse },
            ]);
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      function startVoiceRecognition() {
        // Start speech recognition
        recognition.start();
        recognition.onresult = function (event) {
          const transcript = event.results[0][0].transcript;
          document.getElementById("userInput").value = transcript;
          sendMessage();
        };
      }
    </script>
  </body>
</html>
